<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Stranger Things App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Benguiat+ITC&family=Inter:wght@400;500;700;900&family=Permanent+Marker&display=swap" rel="stylesheet">

    <style>
        /* --- GLOBAL RESET --- */
        *, *::before, *::after { box-sizing: border-box; }

        :root {
            --stranger-red: #ff0909;
            --stranger-glow: #ff1a1a;
            --upside-blue: #0044ff;
            --bg-black: #050505;
            --card-glass: rgba(20, 20, 20, 0.75);
            --card-border: rgba(255, 9, 9, 0.2);
            --text-gray: #a1a1a6;
            --current-glow: var(--stranger-red);
            --nav-height: 70px;
        }

        body {
            margin: 0; padding: 0; 
            background-color: var(--bg-black); 
            color: white;
            font-family: 'Inter', sans-serif; 
            overflow-x: hidden; min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none; user-select: none; -webkit-touch-callout: none;
            padding-top: env(safe-area-inset-top); 
            padding-bottom: calc(env(safe-area-inset-bottom) + var(--nav-height));
            background-image: radial-gradient(circle at 50% 30%, #1a0505 0%, #000000 80%);
            background-attachment: fixed;
        }

        /* SCANLINES */
        body::before {
            content: " "; display: block; position: fixed; top: 0; left: 0; bottom: 0; right: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.25) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.06), rgba(0, 255, 0, 0.02), rgba(0, 0, 255, 0.06));
            z-index: 1000; background-size: 100% 2px, 3px 100%; pointer-events: none; opacity: 0.6;
        }

        body.modal-open { overflow: hidden; position: fixed; width: 100%; height: 100%; }
        ::-webkit-scrollbar { display: none; }
        #upside-down-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; opacity: 0.6; }

        body.glitch-mode { --current-glow: var(--upside-blue); }
        body.glitch-mode h1, body.glitch-mode h2, body.glitch-mode h3, body.glitch-mode p, body.glitch-mode span, body.glitch-mode .stranger-font, body.glitch-mode .countdown-timer { transform: scaleY(-1); filter: hue-rotate(180deg) blur(0.5px); }
        body.glitch-mode #wall-overlay { transform: none !important; filter: none !important; }

        .stranger-font {
            font-family: 'Benguiat ITC', serif; font-weight: 700; color: transparent;
            -webkit-text-stroke: 1.2px var(--current-glow); text-transform: uppercase;
            position: relative; text-align: center; filter: drop-shadow(0 0 6px var(--current-glow));
        }

        /* SPLASH */
        #splash-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            z-index: 9999; background: radial-gradient(circle, #1a0000 0%, #000000 100%);
        }
        .intro-container { display: flex; flex-direction: column; align-items: center; animation: introZoom 3.5s ease-in forwards; transform-origin: center center; }
        .splash-line-1 { font-size: 2rem; letter-spacing: 4px; margin-bottom: -5px; opacity: 0; animation: fadeInWord 1s ease forwards 0.5s; }
        .splash-line-2 { font-size: 2.8rem; letter-spacing: 1px; margin: -5px 0; opacity: 0; animation: fadeInWord 1s ease forwards 1s; }
        .splash-line-3 { font-size: 3.5rem; letter-spacing: 6px; margin-top: -10px; opacity: 0; animation: fadeInWord 1s ease forwards 1.5s; }
        .bar { width: 0%; height: 2px; background-color: var(--stranger-red); box-shadow: 0 0 15px var(--stranger-red); margin: 20px 0; animation: expandBar 2.5s ease-out forwards; }
        @keyframes introZoom { 0% { transform: scale(0.9); opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; transform: scale(10); } }
        @keyframes fadeInWord { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        @keyframes expandBar { 0% { width: 0%; opacity: 0; } 40% { width: 60%; opacity: 1; } 100% { width: 90%; opacity: 0; } }

        /* TOAST NOTIFICATION */
        #toast-notification {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: rgba(20, 0, 0, 0.95); border: 1px solid var(--stranger-red);
            color: white; padding: 12px 20px; border-radius: 30px;
            font-size: 13px; font-weight: 700; z-index: 10000;
            box-shadow: 0 5px 20px rgba(255, 9, 9, 0.3);
            display: flex; align-items: center; gap: 10px;
            transition: top 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            width: 90%; max-width: 350px; justify-content: center; text-align: center;
        }
        #toast-notification.show { top: 20px; }

        /* TABS */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: var(--nav-height);
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(15px);
            border-top: 1px solid var(--card-border);
            display: flex; justify-content: space-around; align-items: center;
            z-index: 500; padding-bottom: env(safe-area-inset-bottom);
        }
        .nav-item {
            flex: 1; height: 100%; display: flex; flex-direction: column; justify-content: center; align-items: center;
            color: #666; transition: all 0.2s; cursor: pointer;
        }
        .nav-item.active { color: var(--stranger-red); text-shadow: 0 0 10px rgba(255, 9, 9, 0.4); }
        .nav-icon { margin-bottom: 4px; }
        .nav-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; }

        /* PAGES */
        .page-container {
            display: none; padding: 10px 16px 20px 16px; max-width: 600px; margin: 0 auto;
            position: relative; z-index: 10; opacity: 0; transition: opacity 0.2s ease; width: 100%;
        }
        .page-container.active-page { display: block; opacity: 1; }

        /* HEADER */
        .app-header { margin-bottom: 20px; margin-top: 25px; display: flex; justify-content: center; align-items: center; flex-direction: column; width: 100%; }
        .header-logo { cursor: pointer; padding: 10px; display: flex; flex-direction: column; align-items: center; transition: transform 0.2s; }
        .header-logo:active { transform: scale(0.95); opacity: 0.8; }
        .header-logo .line { display: block; line-height: 0.8; text-shadow: 0 0 10px rgba(255, 0, 0, 0.5); text-align: center; }
        .header-logo .l1 { font-size: 1.2rem; letter-spacing: 2px; margin-bottom: 2px; }
        .header-logo .l2 { font-size: 2.2rem; letter-spacing: 0px; }
        .header-logo .l3 { font-size: 2.8rem; letter-spacing: 3px; margin-top: -3px; }

        .sound-toggle {
            position: fixed; top: 15px; right: 15px; z-index: 200; width: 40px; height: 40px; border-radius: 50%;
            background: rgba(20, 20, 20, 0.5); border: 1px solid var(--card-border); color: white; display: flex; justify-content: center; align-items: center; cursor: pointer; backdrop-filter: blur(8px); transition: all 0.2s;
        }
        .sound-toggle.muted { opacity: 0.6; }

        /* HERO TIMER */
        .countdown-banner {
            width: 100%; border-radius: 16px; padding: 25px 20px; margin-bottom: 30px; position: relative; overflow: hidden;
            background: linear-gradient(180deg, rgba(30,0,0,0.6) 0%, rgba(10,0,0,0.8) 100%);
            border: 1px solid var(--card-border); box-shadow: 0 0 30px rgba(255, 0, 0, 0.05); backdrop-filter: blur(5px); text-align: center;
        }
        .countdown-timer { font-family: 'Benguiat ITC', serif; font-size: 32px; font-weight: 700; color: #fff; letter-spacing: 2px; margin: 10px 0; text-shadow: 0 0 15px var(--stranger-red); font-variant-numeric: tabular-nums; line-height: 1.2; }
        .banner-label { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--stranger-red); font-weight: 700; opacity: 0.9; }
        .countdown-subtext { font-size: 12px; color: var(--text-gray); margin-top: 8px; font-weight: 500; }

        /* SEASON SELECTOR */
        .season-selector {
            display: flex; gap: 10px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 20px;
            scrollbar-width: none; margin-left: -16px; margin-right: -16px; padding-left: 16px; padding-right: 16px; -webkit-overflow-scrolling: touch;
        }
        .season-selector::-webkit-scrollbar { display: none; }
        .season-btn {
            background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1);
            color: #888; padding: 10px 20px; border-radius: 20px;
            font-size: 14px; font-weight: 700; cursor: pointer; white-space: nowrap;
            transition: 0.2s; font-family: 'Benguiat ITC', serif; letter-spacing: 1px;
            flex-shrink: 0;
        }
        .season-btn.active {
            background: rgba(255, 9, 9, 0.2); color: white; border-color: var(--stranger-red);
            box-shadow: 0 0 15px rgba(255, 9, 9, 0.3);
        }

        /* CARDS & LISTS */
        .section-title { font-family: 'Benguiat ITC', serif; font-size: 24px; color: #fff; margin-bottom: 15px; margin-top: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); border-left: 3px solid var(--stranger-red); padding-left: 12px; letter-spacing: 0.5px; }
        .dates-grid { display: flex; flex-direction: column; gap: 14px; width: 100%; }
        
        .date-card {
            background: var(--card-glass); border-radius: 14px; padding: 15px 18px; display: flex; justify-content: space-between; align-items: center;
            border: 1px solid var(--card-border); box-shadow: 0 4px 15px rgba(0,0,0,0.4); backdrop-filter: blur(10px); cursor: pointer; position: relative; overflow: hidden; transition: transform 0.2s, background 0.3s;
        }
        .date-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 3px; background: var(--current-glow); box-shadow: 2px 0 10px var(--current-glow); }
        .date-card:active { transform: scale(0.98); background: rgba(50,50,50,0.8); }
        .date-info h3 { margin: 0 0 4px 0; font-size: 17px; color: white; font-family: 'Benguiat ITC', serif; letter-spacing: 0.5px; }
        .date-info p { margin: 0; font-size: 13px; color: var(--text-gray); }
        .date-badge-box { background: #181818; width: 52px; height: 52px; border-radius: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center; border: 1px solid #333; flex-shrink: 0; }
        .db-day { font-size: 19px; font-weight: 900; color: white; line-height: 1; }
        .db-month { font-size: 9px; font-weight: 800; color: var(--stranger-red); text-transform: uppercase; margin-top: 2px; }
        .available-text { font-weight: 900; font-size: 10px; color: #00ff44; text-shadow: 0 0 8px rgba(0, 255, 68, 0.4); letter-spacing: 1px; text-transform: uppercase; border: 1px solid #005511; padding: 4px 6px; border-radius: 4px; background: rgba(0,255,68,0.1); }

        .episode-card { 
            display: flex; align-items: center; gap: 15px; margin-bottom: 10px;
            background: var(--card-glass); padding: 14px; border-radius: 14px; 
            border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            cursor: pointer; transition: all 0.2s;
        }
        .episode-card:active { border-color: var(--stranger-red); background: rgba(40, 0, 0, 0.6); transform: scale(0.98); }
        .ep-preview { 
            width: 90px; height: 56px; background: #222; border-radius: 8px; 
            position: relative; overflow: hidden; flex-shrink: 0; 
            background-image: url('https://d13ezvd6yrslxm.cloudfront.net/wp/wp-content/images/stranger-things-season-5-poster-700x394.jpg');
            background-size: cover; opacity: 0.8; box-shadow: 0 0 10px rgba(0,0,0,0.5);
        }
        .ep-preview::after { content: '‚ñ∂'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: #fff; font-size: 16px; text-shadow: 0 0 5px black; }
        .ep-details { flex-grow: 1; }
        .ep-num { font-size: 10px; color: var(--stranger-red); font-weight: 800; margin-bottom: 3px; letter-spacing: 0.5px; text-transform: uppercase; }
        .ep-title { font-size: 15px; color: white; font-weight: 600; line-height: 1.2; margin-bottom: 4px; font-family: 'Benguiat ITC', serif; letter-spacing: 0.5px; }
        .ep-dur { font-size: 11px; color: #888; font-weight: 500; }

        /* PLAYER */
        .player-section { padding: 5px 0; width: 100%; }
        .player-wrapper { position: relative; width: 100%; background-color: #000; border-radius: 14px; overflow: hidden; aspect-ratio: 16 / 9; box-shadow: 0 10px 30px rgba(0,0,0,0.6); background-size: cover; background-position: center; cursor: pointer; border: 1px solid #333; }
        .play-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 60px; height: 60px; background: rgba(200, 20, 20, 0.2); backdrop-filter: blur(4px); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; border: 2px solid white; box-shadow: 0 0 20px rgba(255, 9, 9, 0.5); transition: transform 0.2s; }
        .play-overlay::after { content: '‚ñ∂'; margin-left: 4px; }
        .player-wrapper:active .play-overlay { transform: translate(-50%, -50%) scale(0.9); }
        .controls-area { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; background: var(--card-glass); padding: 10px 14px; border-radius: 12px; border: 1px solid var(--card-border); }
        .nav-btn { background: rgba(255,255,255,0.05); border: none; color: white; width: 36px; height: 36px; border-radius: 10px; font-size: 18px; cursor: pointer; display:flex; align-items:center; justify-content:center; transition: background 0.2s; }
        .nav-btn:active { background: var(--stranger-red); }
        #video-title-text { font-family: 'Benguiat ITC', serif; font-size: 14px; color: #eee; letter-spacing: 0.5px; }

        /* OTHER PAGE STYLES */
        .other-card {
            background: var(--card-glass); border: 1px solid var(--card-border);
            border-radius: 16px; padding: 25px 20px; margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center; text-align: center;
            backdrop-filter: blur(10px); width: 100%;
        }
        .other-icon-box {
            width: 60px; height: 60px; border-radius: 50%;
            background: rgba(255, 9, 9, 0.1); border: 1px solid var(--stranger-red);
            display: flex; justify-content: center; align-items: center;
            margin-bottom: 15px; color: var(--stranger-red);
            box-shadow: 0 0 15px rgba(255, 9, 9, 0.2); transition: 0.3s;
        }
        .other-title { font-family: 'Benguiat ITC', serif; font-size: 18px; margin-bottom: 8px; color: white; }
        .other-text { font-size: 13px; color: var(--text-gray); margin-bottom: 20px; line-height: 1.5; }
        .action-btn {
            background: var(--stranger-red); color: white; border: none;
            padding: 14px 24px; border-radius: 12px; font-weight: 800; font-size: 14px;
            width: 100%; cursor: pointer; transition: all 0.2s;
            box-shadow: 0 5px 15px rgba(255, 9, 9, 0.3);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:active { transform: scale(0.98); opacity: 0.9; }
        .action-btn.secondary { background: rgba(255, 255, 255, 0.1); border: 1px solid rgba(255,255,255,0.2); box-shadow: none; }
        .action-btn.active { background: #00ff44; color: #000; box-shadow: 0 0 15px #00ff44; text-shadow: none; }
        .action-btn.share-style { background: #0088cc; color: white; box-shadow: 0 5px 15px rgba(0, 136, 204, 0.3); }
        .action-btn.disabled { opacity: 0.5; cursor: not-allowed; background: #333; box-shadow: none; }

        /* GAME STYLES */
        #game-canvas-container {
            width: 100%; height: 400px; /* UPDATED HEIGHT */
            background: rgba(0,0,0,0.5); border-radius: 14px; border: 1px solid #333;
            position: relative; overflow: hidden; margin-bottom: 20px;
        }
        #game-canvas { width: 100%; height: 100%; display: block; }
        .game-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: rgba(0,0,0,0.7); z-index: 5;
        }
        .game-score {
            font-family: 'Benguiat ITC', serif; font-size: 32px; color: #fff; text-shadow: 0 0 10px #ff0;
            margin-bottom: 15px;
        }
        .game-balance { font-size: 14px; color: #ccc; margin-bottom: 20px; font-weight: bold; }
        
        .collection-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; width: 100%;
        }
        .collect-card {
            aspect-ratio: 2/3; background: #111; border-radius: 8px; border: 1px solid #333;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 5px; opacity: 0.5; transition: 0.3s;
        }
        .collect-card.unlocked { opacity: 1; border-color: #555; background: #1a1a1a; }
        .collect-card.red { border-color: #ff0000; box-shadow: 0 0 5px #500; }
        .collect-card.blue { border-color: #0088ff; box-shadow: 0 0 5px #005; }
        .cc-icon { font-size: 24px; margin-bottom: 5px; }
        .cc-name { font-size: 9px; text-align: center; color: #fff; font-weight: 700; line-height: 1.1; }

        /* CASE OPENING ANIMATION (CS2 STYLE) */
        #case-opening-overlay {
            position: fixed; top:0; left:0; width:100%; height:100%;
            background: rgba(0,0,0,0.9); z-index: 10000;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        .case-window {
            width: 100%; height: 160px; border-top: 2px solid #333; border-bottom: 2px solid #333;
            background: rgba(20,20,20,0.8); position: relative; overflow: hidden;
            margin-bottom: 30px;
        }
        .center-line {
            position: absolute; left: 50%; top: 0; bottom: 0; width: 4px;
            background: #ffcc00; z-index: 5; transform: translateX(-50%);
            box-shadow: 0 0 10px #ffcc00;
        }
        .case-strip {
            display: flex; height: 100%; align-items: center;
            position: absolute; left: 50%; transition: transform 5s cubic-bezier(0.1, 0, 0.2, 1);
        }
        .case-item {
            width: 100px; height: 120px; background: #151515; border: 1px solid #444;
            margin: 0 5px; flex-shrink: 0; display: flex; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 8px;
        }
        .case-item.red { border-color: #ff0000; box-shadow: inset 0 0 10px #500; }
        .case-item.blue { border-color: #0088ff; box-shadow: inset 0 0 10px #005; }
        .ci-icon { font-size: 32px; margin-bottom: 5px; }
        .ci-name { font-size: 10px; text-align: center; color: #ccc; font-weight: bold; }

        /* EPISODES SUB-PAGE */
        #episodes-page { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background-color: var(--bg-black);
            background-image: radial-gradient(circle at 50% 30%, #1a0505 0%, #000000 80%);
            z-index: 2000; flex-direction: column; padding: 20px 16px; box-sizing: border-box; overflow-y: auto; 
            animation: slideIn 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
        
        .custom-back-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.1); color: #fff; 
            padding: 10px 18px; border-radius: 30px; backdrop-filter: blur(5px);
            font-size: 13px; font-weight: 700; display: flex; align-items: center; gap: 8px; 
            cursor: pointer; margin-bottom: 20px; width: fit-content; transition: 0.2s;
        }
        .custom-back-btn:active { background: rgba(255,9,9,0.3); border-color: var(--stranger-red); }

        .ep-header { margin-bottom: 30px; text-align: center; }
        .ep-header h2 { margin: 5px 0 0; font-size: 28px; color: white; font-family: 'Benguiat ITC', serif; letter-spacing: 1px; text-shadow: 0 0 10px rgba(255,0,0,0.3); }
        .ep-header span { font-size: 11px; color: var(--stranger-red); text-transform: uppercase; letter-spacing: 2px; font-weight: 800; }

        /* CINEMA/MODAL/WALL */
        #cinema-mode { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 5000; flex-direction: column; justify-content: center; align-items: center; }
        .cinema-close-btn { position: absolute; top: max(20px, env(safe-area-inset-top)); right: 20px; z-index: 5010; background: rgba(30, 30, 30, 0.8); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 10px 18px; border-radius: 20px; cursor: pointer; backdrop-filter: blur(10px); font-size: 12px; font-weight: 700; }
        .cinema-player-box { width: 100%; height: 100%; position: relative; display:flex; justify-content:center; align-items:center; background:#000; }
        video#cinema-video, iframe#cinema-iframe { width: 100%; height: 100%; border: none; background: #000; }
        .rescue-btn { position: absolute; bottom: 18%; left: 50%; transform: translateX(-50%); z-index: 5020; background: rgba(255, 9, 9, 0.15); border: 1px solid var(--stranger-red); color: #fff; padding: 10px 24px; border-radius: 30px; font-size: 12px; font-weight: bold; display: flex; gap: 8px; align-items: center; cursor: pointer; box-shadow: 0 0 20px rgba(255,9,9,0.3); backdrop-filter: blur(5px); animation: pulseRescue 3s infinite; }
        @keyframes pulseRescue { 0%, 100% { transform: translateX(-50%) scale(1); } 50% { transform: translateX(-50%) scale(1.05); } }
        .cinema-controls { position: absolute; bottom: 40px; width: 90%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; background: rgba(20,20,20,0.8); padding: 15px; border-radius: 20px; backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.1); }
        .cinema-title { font-size: 14px; font-weight: bold; color: white; margin-bottom: 2px; font-family: 'Benguiat ITC', serif; }
        .cinema-subtitle { font-size: 11px; color: var(--stranger-red); font-weight: 700; letter-spacing: 1px; }

        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 6000; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
        .modal-box { background: #121212; border: 1px solid var(--stranger-red); width: 85%; max-width: 320px; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 0 50px rgba(255, 9, 9, 0.15); animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .modal-title { color: var(--stranger-red); font-family: 'Benguiat ITC', serif; font-size: 20px; margin-bottom: 15px; }
        .channel-preview { background: #1f1f1f; padding: 12px; border-radius: 10px; color: white; margin-bottom: 20px; font-weight: 600; border: 1px dashed #444; }
        .modal-btn { display: block; width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; margin-bottom: 12px; cursor: pointer; font-size: 14px; transition: opacity 0.2s; }
        .modal-btn:active { opacity: 0.8; }
        .btn-sub { background: #0088cc; color: white; }
        .btn-check { background: transparent; border: 1px solid #444; color: #888; transition: 0.2s; }
        .btn-check.shake { animation: shakeBtn 0.4s ease-in-out; border-color: red; color: red; }
        @keyframes shakeBtn { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        #wall-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 300; background-color: #1a1510; background-image: radial-gradient(circle at center, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0.95) 100%), url('https://www.transparenttextures.com/patterns/shattered-island.png'); background-size: cover, 300px; flex-direction: column; justify-content: center; align-items: center; animation: fadeInWall 1s ease forwards; }
        @keyframes fadeInWall { 0% { opacity: 0; } 100% { opacity: 1; } }
        .wall-container { position: relative; width: 95%; max-width: 400px; padding: 20px 0; }
        #wires-svg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 1; }
        .wire-path { fill: none; stroke: #111; stroke-width: 3px; stroke-linecap: round; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); }
        .wall-row { display: flex; justify-content: space-between; padding: 0 10px; margin-bottom: 50px; position: relative; z-index: 2; }
        .letter-wrapper { position: relative; display: flex; flex-direction: column; align-items: center; width: 30px; }
        .bulb { width: 16px; height: 16px; border-radius: 50%; margin-bottom: 15px; position: relative; box-shadow: inset -2px -2px 4px rgba(0,0,0,0.3); opacity: 0.3; }
        .bulb.active { opacity: 1; transform: scale(1.3); filter: brightness(1.8); }
        .bulb.active::after { content: ''; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 6px; height: 6px; background: #fff; border-radius: 50%; box-shadow: 0 0 8px #fff; }
        .wall-char { font-family: 'Permanent Marker', cursive; font-size: 26px; color: #000; line-height: 1; transform: rotate(var(--r)); }
        .b-red { background-color: #ff0000; } .b-red.active { box-shadow: 0 0 30px #ff0000; }
        .b-blue { background-color: #0088ff; } .b-blue.active { box-shadow: 0 0 30px #0088ff; }
        .b-yellow { background-color: #ffcc00; } .b-yellow.active { box-shadow: 0 0 30px #ffcc00; }
        .b-green { background-color: #00ff44; } .b-green.active { box-shadow: 0 0 30px #00ff44; }
        .b-pink { background-color: #ff44ff; } .b-pink.active { box-shadow: 0 0 30px #ff44ff; }
        .close-wall-hint { position: absolute; bottom: 40px; color: rgba(255,255,255,0.4); font-size: 12px; }

    </style>
</head>
<body>
    <audio id="bg-music" src="https://orangefreesounds.com/wp-content/uploads/2023/02/Creepy-grandfather-clock-sound.mp3" loop></audio>
    <audio id="buzz-sound" src="https://www.soundjay.com/mechanical/sounds/electric-buzz-01.mp3"></audio>

    <!-- TOAST -->
    <div id="toast-notification">
        <span style="font-size:16px;">‚ö†Ô∏è</span>
        <span id="toast-text">–°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª!</span>
    </div>

    <!-- CASE ANIMATION (CS2) -->
    <div id="case-opening-overlay">
        <div class="case-window">
            <div class="center-line"></div>
            <div class="case-strip" id="case-strip"></div>
        </div>
        <button class="action-btn" id="case-close-btn" style="width:200px; display:none;" onclick="closeCaseAnimation()">–ó–ê–ë–†–ê–¢–¨</button>
    </div>

    <!-- CINEMA -->
    <div id="cinema-mode">
        <div class="cinema-close-btn" onclick="closeCinema()">‚úï –ó–ê–ö–†–´–¢–¨</div>
        <div class="cinema-player-box">
            <video id="cinema-video" controls playsinline controlsList="nodownload"></video>
            <iframe id="cinema-iframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
            <div id="rescue-btn" class="rescue-btn" onclick="openExternal()" style="display:none;">‚ö†Ô∏è –ù–ï –ì–†–£–ó–ò–¢? –ñ–ú–ò –°–Æ–î–ê</div>
        </div>
        <div class="cinema-controls">
            <div style="text-align:center; width:100%;">
                <div class="cinema-title" id="cinema-title">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–µ—Ä–∏–∏</div>
                <div class="cinema-subtitle" id="cinema-sub">STRANGER THINGS</div>
            </div>
        </div>
    </div>

    <!-- SUB MODAL -->
    <div id="sub-modal" class="modal-overlay">
        <div class="modal-box">
            <div class="modal-title">–î–û–°–¢–£–ü –û–ì–†–ê–ù–ò–ß–ï–ù</div>
            <p style="font-size: 13px; color: #ccc; margin-bottom: 20px; line-height: 1.5;">–î–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —ç–ø–∏–∑–æ–¥–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –∫–∞–Ω–∞–ª</p>
            <div class="channel-preview" id="modal-chan-name">@channel</div>
            <button class="modal-btn btn-sub" onclick="doSubscribe()">–ü–û–î–ü–ò–°–ê–¢–¨–°–Ø</button>
            <button class="modal-btn btn-check" id="check-sub-btn" onclick="checkSubscription()">–Ø –ü–û–î–ü–ò–°–ê–õ–°–Ø</button>
        </div>
    </div>

    <!-- WALL -->
    <div id="wall-overlay" onclick="closeWall()">
        <div class="wall-container" id="wall-container">
            <svg id="wires-svg"></svg>
            <div class="wall-row" id="row-1"></div>
            <div class="wall-row" id="row-2"></div>
            <div class="wall-row" id="row-3"></div>
        </div>
        <div class="close-wall-hint">–ù–∞–∂–º–∏, —á—Ç–æ–±—ã –≤–µ—Ä–Ω—É—Ç—å—Å—è</div>
    </div>

    <button class="sound-toggle muted" id="sound-btn" onclick="toggleSound()">
        <svg id="icon-muted" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5L6 9H2v6h4l5 4V5z"></path><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>
        <svg id="icon-sound" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display:none;"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
    </button>

    <canvas id="upside-down-canvas"></canvas>

    <div id="splash-screen">
        <div class="bar"></div>
        <div class="intro-container">
            <div class="stranger-font splash-line-1">–û–ß–ï–ù–¨</div>
            <div class="stranger-font splash-line-2">–°–¢–†–ê–ù–ù–´–ï</div>
            <div class="stranger-font splash-line-3">–î–ï–õ–ê</div>
        </div>
        <div class="bar"></div>
    </div>

    <!-- EPISODES LIST -->
    <div id="episodes-page">
        <button class="custom-back-btn" onclick="closePart()"><span>‚Üê</span> –ù–ê–ó–ê–î</button>
        <div class="ep-header">
            <span id="ep-part-subtitle">–°–ï–ó–û–ù <span id="current-season-num">1</span></span>
            <h2 id="ep-part-title">–°–ø–∏—Å–æ–∫ —Å–µ—Ä–∏–π</h2>
        </div>
        <div class="episode-list" id="episode-list-container"></div>
    </div>

    <!-- MAIN PAGE -->
    <div id="main-app" class="page-container active-page">
        <div class="app-header">
            <div class="header-logo stranger-font" id="logo-trigger">
                <span class="line l1">–û–ß–ï–ù–¨</span>
                <span class="line l2">–°–¢–†–ê–ù–ù–´–ï</span>
                <span class="line l3">–î–ï–õ–ê</span>
            </div>
        </div>

        <div class="countdown-banner">
            <div class="banner-content">
                <div class="banner-label" id="timer-label">–î–û –í–´–•–û–î–ê –§–ò–ù–ê–õ–¨–ù–û–ô –°–ï–†–ò–ò</div>
                <div class="countdown-timer" id="timer">00 : 00 : 00 : 00</div>
                <div class="countdown-subtext" id="release-date-text">31 –¥–µ–∫–∞–±—Ä—è 2025 ‚Ä¢ 17:00 (PT)</div>
            </div>
        </div>

        <!-- SEASON SELECTOR -->
        <div class="section-title" id="schedule-title" style="margin-top: 10px;">–°–µ–∑–æ–Ω—ã</div>
        <div class="season-selector">
            <div class="season-btn" id="s1-btn" onclick="renderSeason(1)">1 –°–ï–ó–û–ù</div>
            <div class="season-btn" id="s2-btn" onclick="renderSeason(2)">2 –°–ï–ó–û–ù</div>
            <div class="season-btn" id="s3-btn" onclick="renderSeason(3)">3 –°–ï–ó–û–ù</div>
            <div class="season-btn" id="s4-btn" onclick="renderSeason(4)">4 –°–ï–ó–û–ù</div>
            <div class="season-btn active" id="s5-btn" onclick="renderSeason(5)">5 –°–ï–ó–û–ù</div>
        </div>

        <div id="season-container"></div>

        <div class="section-title">–¢—Ä–µ–π–ª–µ—Ä—ã</div>
        <div class="player-section">
            <div class="player-wrapper" id="player-trigger" onclick="playCurrentTrailer()">
                <div class="play-overlay"></div>
            </div>
            <div class="controls-area">
                <button class="nav-btn" onclick="changeTrailer(-1)">‚Äπ</button>
                <div id="video-title-text">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button class="nav-btn" onclick="changeTrailer(1)">‚Ä∫</button>
            </div>
        </div>
    </div>

    <!-- GAME PAGE -->
    <div id="game-page" class="page-container">
        <div class="app-header">
            <div class="header-logo stranger-font">
                <span class="line l1">WAFFLE</span>
                <span class="line l2">RUN</span>
            </div>
        </div>

        <div id="game-canvas-container">
            <canvas id="game-canvas"></canvas>
            <div class="game-overlay" id="game-start-screen">
                <div class="game-score">TAP TO START</div>
                <button class="action-btn" onclick="startGame()">–ò–ì–†–ê–¢–¨</button>
            </div>
            <div class="game-overlay" id="game-over-screen" style="display:none;">
                <div class="game-score" style="color:red; font-size:24px;">GAME OVER</div>
                <div class="game-balance" id="run-score">Score: 0</div>
                <button class="action-btn" onclick="startGame()">RESTART</button>
            </div>
        </div>

        <div class="other-card">
            <div class="other-title">–¢–í–û–ô –ë–ê–õ–ê–ù–°</div>
            <div class="game-score" style="color:#ffcc00; text-shadow:0 0 10px #ff8800;" id="total-waffles">0 üßá</div>
            <button class="action-btn active" id="daily-case-btn" onclick="openDailyCase()">–ï–ñ–ï–î–ù–ï–í–ù–´–ô –ö–ï–ô–° (FREE)</button>
            <button class="action-btn" style="margin-top:10px; background:#444;" onclick="openPaidCase()">–û–¢–ö–†–´–¢–¨ –ö–ï–ô–° (10 üßá)</button>
        </div>

        <div class="section-title">–ú–æ—è –∫–æ–ª–ª–µ–∫—Ü–∏—è</div>
        <div class="collection-grid" id="collection-grid"></div>
    </div>

    <!-- OTHER PAGE -->
    <div id="other-page" class="page-container">
        <div class="app-header">
            <div class="header-logo stranger-font">
                <span class="line l1">–ú–ï–ù–Æ</span>
                <span class="line l2">–î–†–£–ì–û–ï</span>
            </div>
        </div>

        <div class="other-card">
            <div class="other-icon-box" id="notif-icon">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
            </div>
            <div class="other-title" id="notif-title">–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</div>
            <div class="other-text" id="notif-text">
                –í–∫–ª—é—á–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ä–∏–∏. –ë–æ—Ç –Ω–∞–ø–∏—à–µ—Ç —Ç–µ–±–µ –ª–∏—á–Ω–æ!
            </div>
            <button class="action-btn" id="notif-btn" onclick="toggleNotifications()">–í–ö–õ–Æ–ß–ò–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø</button>
        </div>

        <div class="other-card">
            <div class="other-icon-box" style="color:#00ccff; border-color:#00ccff; box-shadow:0 0 15px rgba(0,204,255,0.2);">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
            </div>
            <div class="other-title">–ü–û–î–ï–õ–ò–¢–¨–°–Ø</div>
            <div class="other-text">
                –†–∞—Å—Å–∫–∞–∂–∏ –¥—Ä—É–∑—å—è–º –æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏! –ü—É—Å—Ç—å –æ–Ω–∏ —Ç–æ–∂–µ —Å–ª–µ–¥—è—Ç –∑–∞ —Ñ–∏–Ω–∞–ª–æ–º Stranger Things.
            </div>
            <button class="action-btn share-style" onclick="shareApp()">–ü–û–ó–í–ê–¢–¨ –î–†–£–ó–ï–ô</button>
        </div>

        <div class="other-card">
            <div class="other-icon-box" style="color:#888; border-color:#888; box-shadow:0 0 15px rgba(136,136,136,0.2);">
                <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 2L11 13"></path><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>
            </div>
            <div class="other-title">–°–õ–ï–î–ò –ó–ê –ù–û–í–û–°–¢–Ø–ú–ò</div>
            <div class="other-text">
                –ü–æ–¥–ø–∏—à–∏—Å—å –Ω–∞ –Ω–∞—à –∫–∞–Ω–∞–ª, —á—Ç–æ–±—ã —Å–ª–µ–¥–∏—Ç—å –∑–∞ –Ω–æ–≤–æ—Å—Ç—è–º–∏ –ø–æ –û–°–î –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è–º–∏ –Ω–∞—à–µ–≥–æ –±–æ—Ç–∞!
            </div>
            <button class="action-btn secondary" onclick="openNewsChannel()">–ü–ï–†–ï–ô–¢–ò –í –ö–ê–ù–ê–õ</button>
        </div>
    </div>

    <!-- TABS -->
    <div class="bottom-nav" id="bottom-nav">
        <div class="nav-item active" id="tab-home" onclick="switchTab('home')">
            <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg></div>
            <div class="nav-label">–ì–õ–ê–í–ù–û–ï</div>
        </div>
        <div class="nav-item" id="tab-game" onclick="switchTab('game')">
            <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a10 10 0 1 0 10 10A10 10 0 0 0 12 2zm0 18a8 8 0 1 1 8-8 8 8 0 0 1-8 8z"></path><path d="M12 7v10"></path><path d="M7 12h10"></path></svg></div>
            <div class="nav-label">–ò–ì–†–ê</div>
        </div>
        <div class="nav-item" id="tab-other" onclick="switchTab('other')">
            <div class="nav-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg></div>
            <div class="nav-label">–î–†–£–ì–û–ï</div>
        </div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.ready();
        tg.expand(); tg.setHeaderColor('#050505'); tg.setBackgroundColor('#050505');
        function vibration() { if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light'); }

        const opChannels = [ "strangerthingsfiveseason", "https://t.me/+azpZxcHVlM41OTYy", "https://t.me/+TNUIMbVjwRY3MWFi", "https://t.me/+WnyT5bC4t_VjNzQy", "https://t.me/+ligUp6pRCXtlZTky" ];
        const todayIndex = Math.floor(Date.now() / (1000 * 60 * 60 * 24));
        const currentAutoChannel = opChannels[todayIndex % opChannels.length];

        const config = {
            requiredChannel: currentAutoChannel,
            newsChannel: "https://t.me/strangerthingsfiveseason",
            botShareLink: "https://t.me/share/url?url=https://t.me/strangerthings_5_bot&text=%F0%9F%94%A5%20%D0%A1%D0%BC%D0%BE%D1%82%D1%80%D0%B8%20%D0%B2%D1%81%D0%B5%20%D1%81%D0%B5%D0%B7%D0%BE%D0%BD%D1%8B%20%D0%9E%D1%87%D0%B5%D0%BD%D1%8C%20%D0%A1%D1%82%D1%80%D0%B0%D0%BD%D0%BD%D1%8B%D1%85%20%D0%94%D0%B5%D0%BB%20%D0%BF%D1%80%D1%8F%D0%BC%D0%BE%20%D0%B7%D0%B4%D0%B5%D1%81%D1%8C!",
            trailerLinks: [
                { title: "–¢—Ä–µ–π–ª–µ—Ä 5 —Å–µ–∑–æ–Ω–∞ (–¢–∏–∑–µ—Ä)", poster: "https://images.ctfassets.net/4cd45et68cgf/5QQ9QVyTXgnYGTdrnrJLcd/318041d404d528b846e6a39433436322/Stranger_Things_Season_5_Logo.jpg", link: "https://t.me/strangerthingsfiveseason/5" },
                { title: "–í–∏–¥–µ–æ —Å–æ —Å—ä–µ–º–æ–∫", poster: "https://d13ezvd6yrslxm.cloudfront.net/wp/wp-content/images/stranger-things-season-5-poster-700x394.jpg", link: "https://t.me/strangerthingsfiveseason" }
            ]
        };

        const linksDB = {
            s1: { 
                1: "https://pixeldrain.com/u/PLACEHOLDER_S1E1", 
                2: "https://pixeldrain.com/u/PLACEHOLDER_S1E2",
                3: "https://pixeldrain.com/u/PLACEHOLDER_S1E3",
                4: "https://pixeldrain.com/u/PLACEHOLDER_S1E4",
                5: "https://pixeldrain.com/u/PLACEHOLDER_S1E5",
                6: "https://pixeldrain.com/u/PLACEHOLDER_S1E6",
                7: "https://pixeldrain.com/u/PLACEHOLDER_S1E7",
                8: "https://pixeldrain.com/u/PLACEHOLDER_S1E8"
            },
            s2: { 
                1: "https://pixeldrain.com/u/PLACEHOLDER_S2E1",
                2: "https://pixeldrain.com/u/PLACEHOLDER_S2E2",
                3: "https://pixeldrain.com/u/PLACEHOLDER_S2E3",
                4: "https://pixeldrain.com/u/PLACEHOLDER_S2E4",
                5: "https://pixeldrain.com/u/PLACEHOLDER_S2E5",
                6: "https://pixeldrain.com/u/PLACEHOLDER_S2E6",
                7: "https://pixeldrain.com/u/PLACEHOLDER_S2E7",
                8: "https://pixeldrain.com/u/PLACEHOLDER_S2E8",
                9: "https://pixeldrain.com/u/PLACEHOLDER_S2E9"
            },
            s3: { 
                1: "https://pixeldrain.com/u/PLACEHOLDER_S3E1",
                2: "https://pixeldrain.com/u/PLACEHOLDER_S3E2",
                3: "https://pixeldrain.com/u/PLACEHOLDER_S3E3",
                4: "https://pixeldrain.com/u/PLACEHOLDER_S3E4",
                5: "https://pixeldrain.com/u/PLACEHOLDER_S3E5",
                6: "https://pixeldrain.com/u/PLACEHOLDER_S3E6",
                7: "https://pixeldrain.com/u/PLACEHOLDER_S3E7",
                8: "https://pixeldrain.com/u/PLACEHOLDER_S3E8"
            },
            s4: { 
                1: "https://pixeldrain.com/u/PLACEHOLDER_S4E1",
                2: "https://pixeldrain.com/u/PLACEHOLDER_S4E2",
                3: "https://pixeldrain.com/u/PLACEHOLDER_S4E3",
                4: "https://pixeldrain.com/u/PLACEHOLDER_S4E4",
                5: "https://pixeldrain.com/u/PLACEHOLDER_S4E5",
                6: "https://pixeldrain.com/u/PLACEHOLDER_S4E6",
                7: "https://pixeldrain.com/u/PLACEHOLDER_S4E7",
                8: "https://pixeldrain.com/u/PLACEHOLDER_S4E8",
                9: "https://pixeldrain.com/u/PLACEHOLDER_S4E9"
            },
            s5: {
                1: "https://t.me/strangerthingsfiveseason/17",
                2: "https://t.me/strangerthingsfiveseason/19",
                3: "https://t.me/strangerthingsfiveseason/20",
                4: "https://t.me/strangerthingsfiveseason/21",
                5: "https://pixeldrain.com/u/NHFBNcGA",
                6: "https://pixeldrain.com/u/hKeNyrXj",
                7: "https://pixeldrain.com/u/AbCP8EHM",
                8: "https://pixeldrain.com/u/6vHmCZCD" // Updated Link
            }
        };

        const allSeasonsData = {
            1: [
                { id: 1, name: "–ì–ª–∞–≤–∞ 1: –ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ –£–∏–ª–ª–∞ –ë–∞–π–µ—Ä—Å–∞" }, { id: 2, name: "–ì–ª–∞–≤–∞ 2: –ß—É–¥–∞–∫ –Ω–∞ –ú—ç–π–ø–ª-—Å—Ç—Ä–∏—Ç" },
                { id: 3, name: "–ì–ª–∞–≤–∞ 3: –†–æ–∂–¥–µ—Å—Ç–≤–µ–Ω—Å–∫–∏–µ –æ–≥–Ω–∏" }, { id: 4, name: "–ì–ª–∞–≤–∞ 4: –¢–µ–ª–æ" },
                { id: 5, name: "–ì–ª–∞–≤–∞ 5: –ë–ª–æ—Ö–∞ –∏ –∞–∫—Ä–æ–±–∞—Ç" }, { id: 6, name: "–ì–ª–∞–≤–∞ 6: –ú–æ–Ω—Å—Ç—Ä" },
                { id: 7, name: "–ì–ª–∞–≤–∞ 7: –í–∞–Ω–Ω–∞" }, { id: 8, name: "–ì–ª–∞–≤–∞ 8: –ò–∑–Ω–∞–Ω–∫–∞" }
            ],
            2: [ 
                { id: 1, name: "–ì–ª–∞–≤–∞ 1: MADMAX" }, { id: 2, name: "–ì–ª–∞–≤–∞ 2: –ö–æ—à–µ–ª—ë–∫ –∏–ª–∏ –∂–∏–∑–Ω—å" }, 
                { id: 3, name: "–ì–ª–∞–≤–∞ 3: –ü–æ–ª–ª–∏–≤–æ–≥" }, { id: 4, name: "–ì–ª–∞–≤–∞ 4: –£–∏–ª–ª –ú—É–¥—Ä—ã–π" },
                { id: 5, name: "–ì–ª–∞–≤–∞ 5: Dig Dug" }, { id: 6, name: "–ì–ª–∞–≤–∞ 6: –®–ø–∏–æ–Ω" },
                { id: 7, name: "–ì–ª–∞–≤–∞ 7: –ü–æ—Ç–µ—Ä—è–Ω–Ω–∞—è —Å–µ—Å—Ç—Ä–∞" }, { id: 8, name: "–ì–ª–∞–≤–∞ 8: –ò—Å—Ç—è–∑–∞—Ç–µ–ª—å —Ä–∞–∑—É–º–∞" },
                { id: 9, name: "–ì–ª–∞–≤–∞ 9: –í—Ä–∞—Ç–∞" }
            ],
            3: [ 
                { id: 1, name: "–ì–ª–∞–≤–∞ 1: –°—å—é–∑–∏, –ø—Ä–∏—ë–º!" }, { id: 2, name: "–ì–ª–∞–≤–∞ 2: –ö—Ä—ã—Å—ã" }, 
                { id: 3, name: "–ì–ª–∞–≤–∞ 3: –°–ø–∞—Å–∞—Ç–µ–ª—å" }, { id: 4, name: "–ì–ª–∞–≤–∞ 4: –¢–µ—Å—Ç —Å–∞—É–Ω–æ–π" },
                { id: 5, name: "–ì–ª–∞–≤–∞ 5: –ò—Å—Ç—è–∑–∞–µ–º—ã–µ" }, { id: 6, name: "–ì–ª–∞–≤–∞ 6: E Pluribus Unum" },
                { id: 7, name: "–ì–ª–∞–≤–∞ 7: –£–∫—É—Å" }, { id: 8, name: "–ì–ª–∞–≤–∞ 8: –ë–∏—Ç–≤–∞ –≤ ¬´–°—Ç–∞—Ä–∫–æ—Ä—Ç¬ª" }
            ],
            4: [ 
                { id: 1, name: "–ì–ª–∞–≤–∞ 1: –ö–ª—É–± –ê–¥—Å–∫–æ–≥–æ –ü–ª–∞–º–µ–Ω–∏" }, { id: 2, name: "–ì–ª–∞–≤–∞ 2: –ü—Ä–æ–∫–ª—è—Ç–∏–µ –í–µ–∫–Ω—ã" }, 
                { id: 3, name: "–ì–ª–∞–≤–∞ 3: –ú–æ–Ω—Å—Ç—Ä –∏ —Å—É–ø–µ—Ä–≥–µ—Ä–æ–π" }, { id: 4, name: "–ì–ª–∞–≤–∞ 4: –î–æ—Ä–æ–≥–æ–π –ë–∏–ª–ª–∏" },
                { id: 5, name: "–ì–ª–∞–≤–∞ 5: –ü—Ä–æ–µ–∫—Ç ¬´–ù–∏–Ω–∞¬ª" }, { id: 6, name: "–ì–ª–∞–≤–∞ 6: –ü–æ–≥—Ä—É–∂–µ–Ω–∏–µ" },
                { id: 7, name: "–ì–ª–∞–≤–∞ 7: –†–µ–∑–Ω—è –≤ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–∏–∏" }, { id: 8, name: "–ì–ª–∞–≤–∞ 8: –ü–∞–ø–∞" },
                { id: 9, name: "–ì–ª–∞–≤–∞ 9: –ü—Ä–æ–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–µ" }
            ],
            5: [] 
        };
        
        const s5Parts = [
            { id: 'p1', title: "–ß–∞—Å—Ç—å 1 (4 —Å–µ—Ä–∏–∏)", desc: "–ù–∞—á–∞–ª–æ –∫–æ–Ω—Ü–∞", date: new Date(2025,10,26,17,0,0), eps: [ 
                { id: 1, name: "–ì–ª–∞–≤–∞ 1: –ü–æ–ª–∑–∞–Ω–∏–µ" }, { id: 2, name: "–ì–ª–∞–≤–∞ 2: –ò—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏–µ" }, { id: 3, name: "–ì–ª–∞–≤–∞ 3: –õ–æ–≤—É—à–∫–∞" }, { id: 4, name: "–ì–ª–∞–≤–∞ 4: –ö–æ–ª–¥—É–Ω" } 
            ]},
            { id: 'p2', title: "–ß–∞—Å—Ç—å 2 (3 —Å–µ—Ä–∏–∏)", desc: "–ë–∏—Ç–≤–∞ –∑–∞ –•–æ—É–∫–∏–Ω—Å", date: new Date(2025,11,25,17,0,0), eps: [ 
                { id: 5, name: "–ì–ª–∞–≤–∞ 5: –®–æ–∫–æ–≤–∞—è —Ç–µ—Ä–∞–ø–∏—è" }, { id: 6, name: "–ì–ª–∞–≤–∞ 6: –ü–æ–±–µ–≥ –∏–∑ –ö–∞–º–∞–∑–æ—Ç—Ü" }, { id: 7, name: "–ì–ª–∞–≤–∞ 7: –ú–æ—Å—Ç" } 
            ]},
            { id: 'p3', title: "–ß–∞—Å—Ç—å 3 (1 —Å–µ—Ä–∏—è)", desc: "–§–∏–Ω–∞–ª –∏—Å—Ç–æ—Ä–∏–∏", date: new Date(2025,11,31,17,0,0), eps: [ 
                { id: 8, name: "–ì–ª–∞–≤–∞ 8: –ü—Ä–∞–≤–∞—è —Å—Ç–æ—Ä–æ–Ω–∞" } 
            ]}
        ];

        const charCards = [
            { name: "–û–¥–∏–Ω–Ω–∞–¥—Ü–∞—Ç—å", type: "red", icon: "üßá" }, { name: "–ú–∞–π–∫", type: "red", icon: "üö≤" },
            { name: "–£–∏–ª–ª", type: "red", icon: "üñåÔ∏è" }, { name: "–õ—É–∫–∞—Å", type: "red", icon: "üî¶" },
            { name: "–î–∞—Å—Ç–∏–Ω", type: "red", icon: "üß¢" }, { name: "–ú–∞–∫—Å", type: "red", icon: "üéß" },
            { name: "–°—Ç–∏–≤", type: "red", icon: "üèè" }, { name: "–ù—ç–Ω—Å–∏", type: "red", icon: "üî´" },
            { name: "–•–æ–ø–ø–µ—Ä", type: "red", icon: "üöì" }, { name: "–î–∂–æ–π—Å", type: "red", icon: "üí°" },
            { name: "–î–µ–º–æ–≥–æ—Ä–≥–æ–Ω", type: "blue", icon: "üå∫" }, { name: "–í–µ–∫–Ω–∞", type: "blue", icon: "üï∞Ô∏è" },
            { name: "–ò—Å—Ç—è–∑–∞—Ç–µ–ª—å", type: "blue", icon: "üå™Ô∏è" }, { name: "–î–µ–º–æ–≥–æ–Ω", type: "blue", icon: "üêï" }
        ];

        const splash = document.getElementById('splash-screen');
        const app = document.getElementById('main-app');
        const epPage = document.getElementById('episodes-page');

        setTimeout(() => {
            splash.style.display = 'none'; app.style.display = 'block';
            setTimeout(() => app.style.opacity = '1', 50);
            renderSeason(5); scrollActiveSeasonIntoView();
            checkNotifState(); applyConfig(); setupWall();
            loadGameData(); updateDailyButton();
            document.body.addEventListener('click', initAudioContext, { once: true });
        }, 3800);

        function switchTab(tab) {
            vibration();
            ['main-app', 'other-page', 'game-page'].forEach(id => {
                document.getElementById(id).style.display = 'none';
                document.getElementById(id).classList.remove('active-page');
            });
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));

            if (tab === 'home') {
                document.getElementById('main-app').style.display = 'block';
                setTimeout(()=>document.getElementById('main-app').classList.add('active-page'),10);
                document.getElementById('tab-home').classList.add('active');
            } else if (tab === 'other') {
                document.getElementById('other-page').style.display = 'block';
                setTimeout(()=>document.getElementById('other-page').classList.add('active-page'),10);
                document.getElementById('tab-other').classList.add('active');
            } else if (tab === 'game') {
                document.getElementById('game-page').style.display = 'block';
                setTimeout(()=>document.getElementById('game-page').classList.add('active-page'),10);
                document.getElementById('tab-game').classList.add('active');
                initGame();
            }
        }

        // --- GAME LOGIC ---
        let gameCanvas, ctx, gameLoop;
        let gameState = 'start'; // start, playing, over
        let player = { x: 50, y: 200, dy: 0, w: 36, h: 36 }; // BIGGER PLAYER
        let obstacles = []; let items = [];
        let score = 0; let frame = 0;
        let waffles = 0; let collection = [];

        function loadGameData() {
            waffles = parseInt(localStorage.getItem('user_waffles')) || 0;
            collection = JSON.parse(localStorage.getItem('user_collection')) || [];
            updateGameUI();
            renderCollection();
        }

        function saveGameData() {
            localStorage.setItem('user_waffles', waffles);
            localStorage.setItem('user_collection', JSON.stringify(collection));
            updateGameUI();
        }

        function updateGameUI() {
            document.getElementById('total-waffles').innerText = waffles + " üßá";
        }

        function initGame() {
            gameCanvas = document.getElementById('game-canvas');
            gameCanvas.width = document.getElementById('game-canvas-container').offsetWidth;
            gameCanvas.height = 400; // TALLER CANVAS
            ctx = gameCanvas.getContext('2d');
            
            // Add Touch Listener
            gameCanvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (gameState === 'playing') player.dy = -7; // STRONGER JUMP
            });
            // Click for Desktop testing
            gameCanvas.addEventListener('mousedown', (e) => {
                if (gameState === 'playing') player.dy = -7;
            });
        }

        function startGame() {
            vibration();
            gameState = 'playing';
            document.getElementById('game-start-screen').style.display = 'none';
            document.getElementById('game-over-screen').style.display = 'none';
            
            player.y = 200; player.dy = 0;
            obstacles = []; items = [];
            score = 0; frame = 0;
            
            if (gameLoop) cancelAnimationFrame(gameLoop);
            loop();
        }

        function loop() {
            if (gameState !== 'playing') return;
            
            ctx.clearRect(0, 0, gameCanvas.width, gameCanvas.height);
            frame++;

            // Player Physics
            player.dy += 0.35; // GRAVITY
            player.y += player.dy;

            // Boundaries
            if (player.y + player.h > gameCanvas.height || player.y < 0) {
                gameOver(); return;
            }

            // Draw Player
            ctx.fillStyle = '#fff';
            ctx.font = '32px Arial'; // BIGGER ICON
            ctx.fillText('üö≤', player.x, player.y + 30);

            // Spawner
            if (frame % 110 === 0) {
                // Obstacle (Vine)
                obstacles.push({ x: gameCanvas.width, y: Math.random() > 0.5 ? 0 : gameCanvas.height - 160, w: 36, h: 160 });
            }
            if (frame % 80 === 0) {
                // Item (Waffle)
                items.push({ x: gameCanvas.width, y: Math.random() * (gameCanvas.height - 60) + 30, w: 26, h: 26 });
            }

            // Draw & Update Obstacles
            ctx.fillStyle = '#880000'; // Vines
            for (let i = 0; i < obstacles.length; i++) {
                let obs = obstacles[i];
                obs.x -= 3.5;
                ctx.fillRect(obs.x, obs.y, obs.w, obs.h);
                
                // Collision
                if (rectIntersect(player.x, player.y, player.w, player.h, obs.x, obs.y, obs.w, obs.h)) {
                    gameOver(); return;
                }
            }

            // Draw & Update Items
            ctx.font = '26px Arial';
            for (let i = 0; i < items.length; i++) {
                let item = items[i];
                item.x -= 3.5;
                ctx.fillText('üßá', item.x, item.y + 24);
                
                // Collect
                if (rectIntersect(player.x, player.y, player.w, player.h, item.x, item.y, item.w, item.h)) {
                    waffles++; score++;
                    items.splice(i, 1); i--;
                    if(tg.HapticFeedback) tg.HapticFeedback.selectionChanged();
                }
            }

            // Score Draw
            ctx.fillStyle = '#fff';
            ctx.font = '20px Inter'; // BIGGER SCORE
            ctx.fillText("Score: " + score, 15, 30);

            requestAnimationFrame(loop);
        }

        function rectIntersect(x1, y1, w1, h1, x2, y2, w2, h2) {
            return x2 < x1 + w1 && x2 + w2 > x1 && y2 < y1 + h1 && y2 + h2 > y1;
        }

        function gameOver() {
            if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
            gameState = 'over';
            saveGameData();
            document.getElementById('run-score').innerText = "Waffles collected: " + score;
            document.getElementById('game-over-screen').style.display = 'flex';
        }

        // --- GACHA SYSTEM (CS2 STYLE) ---
        let isSpinning = false;

        function openPaidCase() {
            if(isSpinning) return;
            if (waffles < 10) { alert("–ù–µ —Ö–≤–∞—Ç–∞–µ—Ç –≤–∞—Ñ–µ–ª—å! –ù—É–∂–Ω–æ 10."); return; }
            waffles -= 10;
            saveGameData();
            startCaseAnimation();
        }

        function openDailyCase() {
            if(isSpinning) return;
            const lastBonus = localStorage.getItem('last_daily_bonus');
            const today = new Date().toDateString();
            if (lastBonus === today) { alert("–í—ã —É–∂–µ –æ—Ç–∫—Ä—ã–≤–∞–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–π –∫–µ–π—Å —Å–µ–≥–æ–¥–Ω—è!"); return; }
            
            localStorage.setItem('last_daily_bonus', today);
            updateDailyButton();
            startCaseAnimation();
        }

        function updateDailyButton() {
            const lastBonus = localStorage.getItem('last_daily_bonus');
            const today = new Date().toDateString();
            const btn = document.getElementById('daily-case-btn');
            if (lastBonus === today) {
                btn.classList.remove('active');
                btn.classList.add('disabled');
                btn.innerText = "–£–ñ–ï –ü–û–õ–£–ß–ï–ù–û";
            } else {
                btn.classList.add('active');
                btn.classList.remove('disabled');
                btn.innerText = "–ï–ñ–ï–î–ù–ï–í–ù–´–ô –ö–ï–ô–° (FREE)";
            }
        }

        function startCaseAnimation() {
            isSpinning = true;
            document.getElementById('case-opening-overlay').style.display = 'flex';
            document.getElementById('case-close-btn').style.display = 'none';
            
            const strip = document.getElementById('case-strip');
            strip.innerHTML = '';
            strip.style.transition = 'none';
            strip.style.transform = 'translateX(0)';

            // Winner selection
            const winnerCard = charCards[Math.floor(Math.random() * charCards.length)];
            window.pendingWinner = winnerCard;

            // Build strip: 50 items, winner at index 45
            for (let i = 0; i < 50; i++) {
                let card;
                if (i === 45) {
                    card = winnerCard;
                } else {
                    card = charCards[Math.floor(Math.random() * charCards.length)];
                }
                
                const el = document.createElement('div');
                el.className = `case-item ${card.type}`;
                el.innerHTML = `<div class="ci-icon">${card.icon}</div><div class="ci-name">${card.name}</div>`;
                strip.appendChild(el);
            }

            // Animate
            setTimeout(() => {
                // Card width = 100 + margin 10 = 110. Center offset ~ 50% screen.
                // We want card 45 to be center. 
                // 45 * 110 = 4950px. Add random jitter for realism.
                const jitter = Math.floor(Math.random() * 80) - 40;
                const position = 4950 + jitter - (window.innerWidth / 2) + 55; 
                
                strip.style.transition = 'transform 5s cubic-bezier(0.1, 0, 0.2, 1)';
                strip.style.transform = `translateX(-${position}px)`;
                
                // Sound effect?
                playBuzz();
            }, 100);

            // Finish
            setTimeout(() => {
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                finishCase(winnerCard);
            }, 5500);
        }

        function finishCase(card) {
            document.getElementById('case-close-btn').style.display = 'block';
            
            if (!collection.includes(card.name)) {
                collection.push(card.name);
                showToast(`–ù–æ–≤–∞—è –∫–∞—Ä—Ç–∞: ${card.name}!`);
            } else {
                waffles += 5; 
                showToast(`–ü–æ–≤—Ç–æ—Ä–∫–∞: ${card.name}. +5 üßá`);
            }
            saveGameData();
            renderCollection();
            updateGameUI();
        }

        function closeCaseAnimation() {
            document.getElementById('case-opening-overlay').style.display = 'none';
            isSpinning = false;
        }

        function renderCollection() {
            const grid = document.getElementById('collection-grid');
            grid.innerHTML = '';
            charCards.forEach(c => {
                const unlocked = collection.includes(c.name);
                const el = document.createElement('div');
                el.className = `collect-card ${c.type} ${unlocked ? 'unlocked' : ''}`;
                el.innerHTML = `<div class="cc-icon">${unlocked ? c.icon : 'üîí'}</div><div class="cc-name">${c.name}</div>`;
                grid.appendChild(el);
            });
        }

        // --- EXISTING LOGIC ---
        function scrollActiveSeasonIntoView() {
            const activeBtn = document.querySelector('.season-btn.active');
            if(activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
        }

        function renderSeason(seasonNum) {
            vibration();
            document.querySelectorAll('.season-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`s${seasonNum}-btn`).classList.add('active');
            const container = document.getElementById('season-container');
            container.innerHTML = '';

            if (seasonNum === 5) {
                const datesGrid = document.createElement('div');
                datesGrid.className = 'dates-grid';
                const now = new Date();
                s5Parts.forEach((part, index) => {
                    const isOut = now >= part.date;
                    const badge = isOut ? `<div class="available-text">–î–û–°–¢–£–ü–ù–û</div>` : 
                        `<div class="date-badge-box"><span class="db-day">${part.date.getDate()}</span><span class="db-month">${part.date.toLocaleString('default',{month:'short'})}</span></div>`;
                    const card = document.createElement('div');
                    card.className = 'date-card';
                    card.innerHTML = `<div class="date-info"><h3>${part.title}</h3><p>${part.desc}</p></div>${badge}`;
                    card.onclick = () => openS5Part(index);
                    datesGrid.appendChild(card);
                });
                container.appendChild(datesGrid);
            } else {
                const list = document.createElement('div');
                list.className = 'dates-grid';
                const eps = allSeasonsData[seasonNum] || [];
                eps.forEach(ep => {
                    const card = document.createElement('div');
                    card.className = 'episode-card';
                    card.innerHTML = `<div class="ep-preview"></div><div class="ep-details"><div class="ep-num">–°–ï–ó–û–ù ${seasonNum} ‚Ä¢ –≠–ü–ò–ó–û–î ${ep.id}</div><div class="ep-title">${ep.name}</div></div>`;
                    const globalId = `s${seasonNum}e${ep.id}`;
                    card.onclick = () => { vibration(); openCinema(globalId, ep.name, `–°–ï–ó–û–ù ${seasonNum}`); };
                    list.appendChild(card);
                });
                container.appendChild(list);
            }
        }

        function openS5Part(partIndex) {
            vibration();
            const part = s5Parts[partIndex];
            const now = new Date();
            if (now < part.date) { alert('–≠—Ç–∞ —á–∞—Å—Ç—å –µ—â–µ –Ω–µ –≤—ã—à–ª–∞!'); return; }
            const listContainer = document.getElementById('episode-list-container');
            listContainer.innerHTML = '';
            document.getElementById('ep-part-title').innerText = part.title;
            document.getElementById('current-season-num').innerText = "5";
            part.eps.forEach(ep => {
                const card = document.createElement('div'); card.className = 'episode-card';
                card.innerHTML = `<div class="ep-preview"></div><div class="ep-details"><div class="ep-num">–≠–ü–ò–ó–û–î ${ep.id}</div><div class="ep-title">${ep.name}</div></div>`;
                const globalId = `s5e${ep.id}`;
                card.onclick = () => { vibration(); openCinema(globalId, ep.name, "–°–ï–ó–û–ù 5"); };
                listContainer.appendChild(card);
            });
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('episodes-page').style.display = 'flex';
            tg.BackButton.show(); tg.BackButton.onClick(closePart);
        }

        function closePart() { 
            vibration(); 
            document.getElementById('episodes-page').style.display = 'none'; 
            document.getElementById('main-app').style.display = 'block'; 
            tg.BackButton.hide(); tg.BackButton.offClick(closePart); 
        }

        let pendingVideo = null;
        let clickedSubLink = false;

        function openCinema(globalId, title, subtitle) {
            if (!checkSubRequirement(globalId, title, subtitle)) return;
            const regex = /s(\d+)e(\d+)/;
            const match = globalId.match(regex);
            if(!match) return;
            const s = `s${match[1]}`;
            const e = match[2];
            const link = linksDB[s] && linksDB[s][e] ? linksDB[s][e] : "";
            if (!link || link.includes("PLACEHOLDER")) { alert("–°–µ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."); return; }
            vibration();
            document.getElementById('cinema-title').innerText = title;
            document.getElementById('cinema-sub').innerText = subtitle;
            const vid = document.getElementById('cinema-video');
            const iframe = document.getElementById('cinema-iframe');
            const rescue = document.getElementById('rescue-btn');
            window.currentVideoUrl = link;
            if (link.includes("t.me")) { tg.openTelegramLink(link); return; }
            if (link.includes("pixeldrain")) {
                let id = link.split('/').pop();
                if(id.includes('?')) id = id.split('?')[0];
                const embedUrl = `https://pixeldrain.com/u/${id}?embed`;
                vid.style.display = 'none'; vid.pause();
                iframe.style.display = 'block'; iframe.src = embedUrl;
                rescue.style.display = 'flex';
            } else {
                iframe.style.display = 'none'; iframe.src = "";
                vid.style.display = 'block'; vid.src = link;
                vid.play().catch(e=>{});
                rescue.style.display = 'none';
            }
            document.getElementById('cinema-mode').style.display = 'flex';
            document.body.classList.add('modal-open'); 
            if(!isMuted) bgAudio.pause();
        }

        function checkSubRequirement(vidId, title, sub) {
            // DAILY CHECK
            const lastSubDate = localStorage.getItem('sub_confirmed_date');
            const today = new Date().toDateString();
            
            if (lastSubDate === today) return true; // Already subbed today

            pendingVideo = { id: vidId, t: title, s: sub };
            clickedSubLink = false; 
            const chan = config.requiredChannel;
            const nameEl = document.getElementById('modal-chan-name');
            const subBtn = document.querySelector('.btn-sub');
            if (chan.startsWith('http')) { nameEl.innerText = "–ö–ê–ù–ê–õ –ü–û –û–°–î"; subBtn.innerText = "–ü–û–î–ê–¢–¨ –ó–ê–Ø–í–ö–£"; } else { nameEl.innerText = "@" + chan; subBtn.innerText = "–ü–û–î–ü–ò–°–ê–¢–¨–°–Ø"; }
            document.getElementById('sub-modal').style.display = 'flex';
            return false;
        }

        function doSubscribe() { 
            vibration();
            clickedSubLink = true;
            const chan = config.requiredChannel;
            if (chan.startsWith('http')) { tg.openTelegramLink(chan); } else { tg.openTelegramLink("https://t.me/" + chan); } 
        }

        function checkSubscription() {
            vibration(); 
            if (!clickedSubLink) {
                showToast("–°–Ω–∞—á–∞–ª–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–µ—Ä–µ–π—Ç–∏ –≤ –∫–∞–Ω–∞–ª!");
                const btn = document.getElementById('check-sub-btn');
                btn.classList.add('shake');
                setTimeout(() => btn.classList.remove('shake'), 500);
                if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('error');
                return;
            }
            
            // Save today's date
            localStorage.setItem('sub_confirmed_date', new Date().toDateString());

            document.getElementById('sub-modal').style.display = 'none';
            if (pendingVideo) { openCinema(pendingVideo.id, pendingVideo.t, pendingVideo.s); pendingVideo = null; }
        }

        function openExternal() { if (window.currentVideoUrl) tg.openLink(window.currentVideoUrl); }
        function closeCinema() { vibration(); document.getElementById('cinema-mode').style.display = 'none'; document.body.classList.remove('modal-open'); document.getElementById('cinema-video').pause(); document.getElementById('cinema-video').src = ''; document.getElementById('cinema-iframe').src = ''; if(!isMuted) bgAudio.play(); }
        function openNewsChannel() { vibration(); tg.openTelegramLink(config.newsChannel); }
        function shareApp() { vibration(); tg.openTelegramLink(config.botShareLink); }
        function showToast(msg) { const toast = document.getElementById('toast-notification'); document.getElementById('toast-text').innerText = msg; toast.classList.add('show'); setTimeout(() => toast.classList.remove('show'), 2500); }
        function checkNotifState() { const status = localStorage.getItem('notif_status'); updateNotifUI(status === 'active'); }
        function toggleNotifications() { vibration(); const current = localStorage.getItem('notif_status'); if (current === 'active') { localStorage.setItem('notif_status', 'inactive'); updateNotifUI(false); } else { if (!tg.requestWriteAccess) { localStorage.setItem('notif_status', 'active'); updateNotifUI(true); return; } tg.requestWriteAccess((allowed) => { if (allowed) { localStorage.setItem('notif_status', 'active'); updateNotifUI(true); } }); } }
        function updateNotifUI(isActive) { const btn = document.getElementById('notif-btn'); const icon = document.getElementById('notif-icon'); const text = document.getElementById('notif-text'); if (isActive) { btn.classList.add('active'); btn.innerText = "–£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –í–ö–õ–Æ–ß–ï–ù–´"; icon.style.color = "#00ff44"; icon.style.borderColor = "#00ff44"; icon.style.boxShadow = "0 0 15px rgba(0,255,68,0.2)"; text.innerText = "–í—ã —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–ø–∏—Å–∞–ª–∏—Å—å –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è."; } else { btn.classList.remove('active'); btn.innerText = "–í–ö–õ–Æ–ß–ò–¢–¨ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø"; icon.style.color = "var(--stranger-red)"; icon.style.borderColor = "var(--stranger-red)"; icon.style.boxShadow = "0 0 15px rgba(255,9,9,0.2)"; text.innerText = "–í–∫–ª—é—á–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤—ã—Ö–æ–¥ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å–µ—Ä–∏–∏."; } }
        const bgAudio = document.getElementById('bg-music'); const buzzAudio = document.getElementById('buzz-sound'); const soundBtn = document.getElementById('sound-btn'); const iconMuted = document.getElementById('icon-muted'); const iconSound = document.getElementById('icon-sound'); let isMuted = true; bgAudio.volume = 0.15; buzzAudio.volume = 0.4;
        function initAudioContext() { }
        function toggleSound() { vibration(); isMuted = !isMuted; if (isMuted) { bgAudio.pause(); soundBtn.classList.add('muted'); iconMuted.style.display='block'; iconSound.style.display='none'; } else { bgAudio.play().catch(e=>{}); soundBtn.classList.remove('muted'); iconMuted.style.display='none'; iconSound.style.display='block'; } }
        function playBuzz() { if(isMuted) return; buzzAudio.currentTime = 0; buzzAudio.play().catch(e=>{}); }
        const wallOverlay = document.getElementById('wall-overlay'); const logoTrigger = document.getElementById('logo-trigger'); const wiresSvg = document.getElementById('wires-svg'); let pressTimer; let wallBuilt = false; let messageTimeouts = [];
        logoTrigger.addEventListener('mousedown', startPress); logoTrigger.addEventListener('touchstart', startPress); logoTrigger.addEventListener('mouseup', endPress); logoTrigger.addEventListener('touchend', endPress); logoTrigger.addEventListener('mouseleave', endPress);
        function startPress(e) { pressTimer = setTimeout(() => { openWall(); }, 1200); }
        function endPress(e) { clearTimeout(pressTimer); }
        function setupWall() { if(wallBuilt) return; const alphabet = "ABCDEFGHIJKLMNOPQRSTUVWXYZ"; const rows = [ alphabet.slice(0, 8), alphabet.slice(8, 17), alphabet.slice(17) ]; const colors = ['b-red', 'b-blue', 'b-yellow', 'b-green', 'b-pink']; rows.forEach((rowChars, idx) => { const rowEl = document.getElementById(`row-${idx+1}`); rowChars.split('').forEach(char => { const wrapper = document.createElement('div'); wrapper.className = 'letter-wrapper'; wrapper.id = `char-${char}`; const colorClass = colors[Math.floor(Math.random() * colors.length)]; const rotation = Math.floor(Math.random() * 20) - 10; wrapper.innerHTML = `<div class="bulb ${colorClass}"></div><div class="wall-char" style="--r: ${rotation}deg">${char}</div>`; rowEl.appendChild(wrapper); }); }); wallBuilt = true; }
        function drawWires() { wiresSvg.innerHTML = ''; const bulbs = document.querySelectorAll('.bulb'); let pathD = ""; let prevX, prevY; const containerRect = document.getElementById('wall-container').getBoundingClientRect(); bulbs.forEach((bulb, index) => { const rect = bulb.getBoundingClientRect(); const x = rect.left + rect.width/2 - containerRect.left; const y = rect.top + rect.height/2 - containerRect.top; if (index === 0) pathD += `M ${x} ${y} `; else { const cX = (prevX + x) / 2; const cY = Math.max(prevY, y) + 20 + Math.random()*10; pathD += `Q ${cX} ${cY}, ${x} ${y} `; } prevX = x; prevY = y; }); const path = document.createElementNS("http://www.w3.org/2000/svg", "path"); path.setAttribute("d", pathD); path.setAttribute("class", "wire-path"); wiresSvg.appendChild(path); }
        function openWall() { vibration(); if(tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success'); wallOverlay.style.display = 'flex'; bgAudio.volume = 0.05; setTimeout(() => { drawWires(); startMessageSequence("nevermind"); }, 500); }
        function closeWall() { wallOverlay.style.display = 'none'; messageTimeouts.forEach(t => clearTimeout(t)); document.querySelectorAll('.bulb').forEach(b => b.classList.remove('active')); bgAudio.volume = 0.15; }
        function startMessageSequence(text) { const chars = text.toUpperCase().split(''); let delay = 1000; chars.forEach((char) => { const wrapper = document.getElementById(`char-${char}`); if (wrapper) { const bulb = wrapper.querySelector('.bulb'); messageTimeouts.push(setTimeout(() => { bulb.classList.add('active'); playBuzz(); if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium'); }, delay)); messageTimeouts.push(setTimeout(() => { bulb.classList.remove('active'); }, delay + 800)); delay += 1200; } }); }
        const dates = { 1: new Date(2025,10,26,17,0,0), 2: new Date(2025,11,25,17,0,0), 3: new Date(2025,11,31,17,0,0) };
        const finaleDate = dates[3]; // 31 –¥–µ–∫ 2025
        document.getElementById('release-date-text').innerText = finaleDate.toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }) + " (–í–∞—à–µ –≤—Ä–µ–º—è)";
        const playerWrapper = document.getElementById('player-trigger'); const titleText = document.getElementById('video-title-text'); let currentIdx = 0;
        function applyConfig() { const activeTrailers = config.trailerLinks || []; if(activeTrailers.length > 0) { currentIdx = 0; loadTrailer(0); } else { titleText.innerText = "–¢—Ä–µ–π–ª–µ—Ä–æ–≤ –Ω–µ—Ç"; } }
        function loadTrailer(index) { const activeTrailers = config.trailerLinks; if (activeTrailers.length === 0) return; const item = activeTrailers[index]; playerWrapper.style.backgroundImage = `url('${item.poster}')`; titleText.innerText = item.title; }
        function playCurrentTrailer() { const activeTrailers = config.trailerLinks; if (activeTrailers.length === 0) return; vibration(); const link = activeTrailers[currentIdx].link; tg.openTelegramLink(link); }
        function changeTrailer(direction) { vibration(); const activeTrailers = config.trailerLinks; if (activeTrailers.length === 0) return; currentIdx += direction; if (currentIdx < 0) currentIdx = activeTrailers.length - 1; if (currentIdx >= activeTrailers.length) currentIdx = 0; loadTrailer(currentIdx); }
        function checkDates() { const now = new Date(); for(let i=1;i<=3;i++){ if(now>=dates[i]){ const b=document.getElementById(`badge-part-${i}`); if(b)b.outerHTML=`<div class="available-text">–î–û–°–¢–£–ü–ù–û</div>`; } } }
        function updateTimer(){ const now = new Date().getTime(); const dist = finaleDate.getTime() - now; if(dist < 0){ document.getElementById("timer").innerHTML="–î–û–°–¢–£–ü–ù–û"; document.getElementById("timer").style.color="#0f0"; return; } const d=Math.floor(dist/(1000*60*60*24)); const h=Math.floor((dist%(1000*60*60*24))/(1000*60*60)); const m=Math.floor((dist%(1000*60*60))/(1000*60)); const s=Math.floor((dist%(1000*60))/1000); document.getElementById("timer").innerHTML=`${d}:${h<10?'0'+h:h}:${m<10?'0'+m:m}:${s<10?'0'+s:s}`; } 
        setInterval(updateTimer,1000); updateTimer();
    </script>
</body>
</html>
